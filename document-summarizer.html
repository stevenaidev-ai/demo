<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Document Summarizer</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Mammoth (DOCX parser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #242838;
      --border: #2e3248;
      --accent: #7c6af7;
      --accent-light: #a89cf8;
      --accent-glow: rgba(124, 106, 247, 0.25);
      --text: #e8eaf6;
      --text-muted: #8890b0;
      --success: #34d399;
      --error: #f87171;
      --radius: 14px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px 60px;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      text-align: center;
      margin-bottom: 36px;
    }
    .header .logo {
      width: 52px; height: 52px;
      background: linear-gradient(135deg, var(--accent), #c084fc);
      border-radius: 14px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 26px;
      margin-bottom: 14px;
      box-shadow: 0 0 32px var(--accent-glow);
    }
    .header h1 {
      font-size: 28px; font-weight: 700;
      background: linear-gradient(135deg, #fff 30%, var(--accent-light));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header p {
      color: var(--text-muted); font-size: 15px; margin-top: 6px;
    }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      width: 100%; max-width: 680px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 13px; font-weight: 600; letter-spacing: .06em;
      text-transform: uppercase; color: var(--text-muted);
      margin-bottom: 14px;
    }

    /* ‚îÄ‚îÄ API Key ‚îÄ‚îÄ */
    .key-row {
      display: flex; gap: 10px; align-items: center;
    }
    .key-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 11px 14px;
      color: var(--text); font-size: 14px;
      outline: none; transition: border-color .2s;
      font-family: 'Courier New', monospace;
    }
    .key-input:focus { border-color: var(--accent); }
    .key-input::placeholder { color: var(--text-muted); font-family: inherit; }

    .toggle-btn {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; padding: 11px 14px;
      color: var(--text-muted); cursor: pointer; font-size: 16px;
      transition: all .2s;
    }
    .toggle-btn:hover { border-color: var(--accent); color: var(--accent); }

    .key-hint {
      font-size: 12px; color: var(--text-muted); margin-top: 8px;
    }
    .key-hint a { color: var(--accent-light); text-decoration: none; }
    .key-hint a:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ Model selector ‚îÄ‚îÄ */
    .model-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 11px 14px;
      color: var(--text); font-size: 14px;
      outline: none; transition: border-color .2s;
      width: 100%;
      cursor: pointer;
    }
    .model-select:focus { border-color: var(--accent); }
    .model-select option { background: var(--surface2); }

    /* ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 40px 24px;
      text-align: center;
      cursor: pointer;
      transition: all .25s;
      position: relative;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: var(--accent-glow);
    }
    .drop-zone .dz-icon { font-size: 38px; margin-bottom: 12px; }
    .drop-zone .dz-label {
      font-size: 16px; font-weight: 600; color: var(--text);
      margin-bottom: 6px;
    }
    .drop-zone .dz-sub {
      font-size: 13px; color: var(--text-muted);
    }
    .drop-zone .dz-types {
      display: inline-flex; gap: 6px; margin-top: 14px;
    }
    .badge {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 6px; padding: 3px 10px;
      font-size: 12px; font-weight: 600; color: var(--text-muted);
    }
    #file-input { display: none; }

    /* ‚îÄ‚îÄ File Preview ‚îÄ‚îÄ */
    .file-preview {
      display: none;
      align-items: center; gap: 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      margin-top: 14px;
    }
    .file-preview.visible { display: flex; }
    .file-icon { font-size: 28px; }
    .file-info { flex: 1; min-width: 0; }
    .file-name {
      font-size: 14px; font-weight: 600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .file-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .file-remove {
      background: none; border: none; color: var(--text-muted);
      cursor: pointer; font-size: 18px; padding: 4px;
      transition: color .2s;
    }
    .file-remove:hover { color: var(--error); }

    /* ‚îÄ‚îÄ Options ‚îÄ‚îÄ */
    .options-row {
      display: flex; gap: 12px; margin-top: 4px;
    }
    .option-item { flex: 1; }
    .option-label {
      font-size: 12px; color: var(--text-muted);
      margin-bottom: 6px; display: block;
    }

    /* ‚îÄ‚îÄ Summarize Button ‚îÄ‚îÄ */
    .summarize-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      border: none; border-radius: 12px;
      padding: 15px;
      font-size: 16px; font-weight: 700;
      color: #fff; cursor: pointer;
      transition: all .25s;
      box-shadow: 0 4px 24px var(--accent-glow);
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .summarize-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px var(--accent-glow);
    }
    .summarize-btn:disabled {
      opacity: .45; cursor: not-allowed; transform: none;
    }

    /* ‚îÄ‚îÄ Spinner ‚îÄ‚îÄ */
    .spinner {
      width: 18px; height: 18px;
      border: 2.5px solid rgba(255,255,255,.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Summary Output ‚îÄ‚îÄ */
    .output-card { display: none; }
    .output-card.visible { display: block; }

    .output-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .output-header .title-group {
      display: flex; align-items: center; gap: 8px;
    }
    .success-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }
    .output-title { font-size: 15px; font-weight: 600; }

    .copy-btn {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 6px 14px;
      color: var(--text-muted); font-size: 13px; cursor: pointer;
      transition: all .2s; display: flex; align-items: center; gap: 6px;
    }
    .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
    .copy-btn.copied { border-color: var(--success); color: var(--success); }

    .summary-text {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      font-size: 15px; line-height: 1.75;
      color: var(--text);
      white-space: pre-wrap;
    }

    .token-info {
      font-size: 12px; color: var(--text-muted);
      margin-top: 10px; text-align: right;
    }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    .error-box {
      display: none;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.4);
      border-radius: 10px;
      padding: 14px 18px;
      font-size: 14px; color: var(--error);
      margin-top: 14px;
    }
    .error-box.visible { display: block; }

    /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
    .progress-bar-wrap {
      display: none;
      background: var(--surface2);
      border-radius: 100px;
      height: 4px; overflow: hidden;
      margin-top: 14px;
    }
    .progress-bar-wrap.visible { display: block; }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #c084fc);
      border-radius: 100px;
      width: 0%;
      transition: width .4s ease;
      animation: shimmer 1.5s ease infinite;
    }
    @keyframes shimmer {
      0%,100% { opacity: 1; } 50% { opacity: .6; }
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 480px) {
      .options-row { flex-direction: column; }
      .key-row { flex-wrap: wrap; }
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="header">
    <div class="logo">‚ú¶</div>
    <h1>AI Document Summarizer</h1>
    <p>Upload any document and get an instant AI-powered summary</p>
  </div>

  <!-- API Key Card -->
  <div class="card">
    <div class="card-title">üîë Anthropic API Key</div>
    <div class="key-row">
      <input id="api-key" class="key-input" type="password" placeholder="sk-ant-api03-..." autocomplete="off" />
      <button class="toggle-btn" id="toggle-key" title="Show/Hide key">üëÅ</button>
    </div>
    <p class="key-hint">
      Your key is never sent anywhere except Anthropic's API.
      Get yours at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>.
    </p>
  </div>

  <!-- Upload Card -->
  <div class="card">
    <div class="card-title">üìÑ Document</div>

    <div class="drop-zone" id="drop-zone">
      <input type="file" id="file-input" accept=".txt,.pdf,.docx,.doc,.md" />
      <div class="dz-icon">üìÇ</div>
      <div class="dz-label">Drop your file here or click to browse</div>
      <div class="dz-sub">Supported formats:</div>
      <div class="dz-types">
        <span class="badge">TXT</span>
        <span class="badge">PDF</span>
        <span class="badge">DOCX</span>
        <span class="badge">MD</span>
      </div>
    </div>

    <div class="file-preview" id="file-preview">
      <div class="file-icon" id="file-icon">üìÑ</div>
      <div class="file-info">
        <div class="file-name" id="file-name">document.pdf</div>
        <div class="file-meta" id="file-meta">‚Äì</div>
      </div>
      <button class="file-remove" id="file-remove" title="Remove file">‚úï</button>
    </div>

    <div class="error-box" id="extract-error"></div>
    <div class="progress-bar-wrap" id="progress-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <!-- Options Card -->
  <div class="card">
    <div class="card-title">‚öôÔ∏è Options</div>
    <div class="options-row">
      <div class="option-item">
        <label class="option-label">Model</label>
        <select class="model-select" id="model-select">
          <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 ‚Äî Fast &amp; cheap</option>
          <option value="claude-sonnet-4-5-20250929" selected>Claude Sonnet 4.5 ‚Äî Balanced</option>
          <option value="claude-opus-4-5-20251101">Claude Opus 4.5 ‚Äî Most capable</option>
        </select>
      </div>
      <div class="option-item">
        <label class="option-label">Summary length</label>
        <select class="model-select" id="length-select">
          <option value="brief">Brief (2‚Äì3 sentences)</option>
          <option value="standard" selected>Standard (1 paragraph)</option>
          <option value="detailed">Detailed (key points)</option>
          <option value="executive">Executive (one-pager)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Summarize Button -->
  <div style="width:100%;max-width:680px;margin-bottom:20px;">
    <button class="summarize-btn" id="summarize-btn" disabled>
      <div class="spinner" id="spinner"></div>
      <span id="btn-label">‚ú¶ Summarize Document</span>
    </button>
  </div>

  <!-- Output Card -->
  <div class="card output-card" id="output-card">
    <div class="output-header">
      <div class="title-group">
        <div class="success-dot"></div>
        <span class="output-title">Summary</span>
      </div>
      <button class="copy-btn" id="copy-btn">
        <span>üìã</span> <span id="copy-label">Copy</span>
      </button>
    </div>
    <div class="summary-text" id="summary-text"></div>
    <div class="token-info" id="token-info"></div>
  </div>

  <div class="error-box" id="api-error" style="width:100%;max-width:680px;margin-top:-10px;"></div>

<script>
// ‚îÄ‚îÄ Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let extractedText = '';
let currentFile   = null;

// ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dropZone      = document.getElementById('drop-zone');
const fileInput     = document.getElementById('file-input');
const filePreview   = document.getElementById('file-preview');
const fileIconEl    = document.getElementById('file-icon');
const fileNameEl    = document.getElementById('file-name');
const fileMetaEl    = document.getElementById('file-meta');
const fileRemoveBtn = document.getElementById('file-remove');
const extractError  = document.getElementById('extract-error');
const progressWrap  = document.getElementById('progress-wrap');
const progressBar   = document.getElementById('progress-bar');

const apiKeyInput   = document.getElementById('api-key');
const toggleKeyBtn  = document.getElementById('toggle-key');
const modelSelect   = document.getElementById('model-select');
const lengthSelect  = document.getElementById('length-select');

const summarizeBtn  = document.getElementById('summarize-btn');
const spinner       = document.getElementById('spinner');
const btnLabel      = document.getElementById('btn-label');

const outputCard    = document.getElementById('output-card');
const summaryText   = document.getElementById('summary-text');
const tokenInfo     = document.getElementById('token-info');
const copyBtn       = document.getElementById('copy-btn');
const copyLabel     = document.getElementById('copy-label');
const apiError      = document.getElementById('api-error');

// ‚îÄ‚îÄ Toggle API key visibility ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
toggleKeyBtn.addEventListener('click', () => {
  const show = apiKeyInput.type === 'password';
  apiKeyInput.type = show ? 'text' : 'password';
  toggleKeyBtn.textContent = show ? 'üôà' : 'üëÅ';
});

// ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) handleFile(fileInput.files[0]);
});
fileRemoveBtn.addEventListener('click', clearFile);

function clearFile() {
  currentFile   = null;
  extractedText = '';
  fileInput.value = '';
  filePreview.classList.remove('visible');
  dropZone.style.display = 'flex';
  showExtractError('');
  hideProgress();
  updateBtn();
  outputCard.classList.remove('visible');
  apiError.classList.remove('visible');
}

function formatBytes(n) {
  if (n < 1024)       return n + ' B';
  if (n < 1024*1024)  return (n/1024).toFixed(1) + ' KB';
  return (n/1024/1024).toFixed(1) + ' MB';
}

function fileExtIcon(ext) {
  const m = { pdf:'üìï', docx:'üìò', doc:'üìò', txt:'üìÑ', md:'üìù' };
  return m[ext] || 'üìÑ';
}

async function handleFile(file) {
  currentFile   = file;
  extractedText = '';
  showExtractError('');
  hideProgress();
  outputCard.classList.remove('visible');
  apiError.classList.remove('visible');

  const ext = file.name.split('.').pop().toLowerCase();
  fileIconEl.textContent = fileExtIcon(ext);
  fileNameEl.textContent = file.name;
  fileMetaEl.textContent = formatBytes(file.size);

  dropZone.style.display = 'none';
  filePreview.classList.add('visible');
  updateBtn();

  showProgress(10);

  try {
    if (ext === 'txt' || ext === 'md') {
      extractedText = await readAsText(file);
    } else if (ext === 'pdf') {
      extractedText = await extractPDF(file);
    } else if (ext === 'docx' || ext === 'doc') {
      extractedText = await extractDOCX(file);
    } else {
      showExtractError('Unsupported file type. Please use TXT, PDF, DOCX, or MD.');
      currentFile = null;
      updateBtn();
      hideProgress();
      return;
    }

    if (!extractedText.trim()) {
      showExtractError('Could not extract text from this file. It may be an image-based PDF or an empty document.');
      currentFile = null;
      updateBtn();
      hideProgress();
      return;
    }

    const wordCount = extractedText.trim().split(/\s+/).length;
    fileMetaEl.textContent = `${formatBytes(file.size)} ¬∑ ~${wordCount.toLocaleString()} words extracted`;
    showProgress(100);
    setTimeout(hideProgress, 600);

  } catch (err) {
    showExtractError('Failed to read file: ' + err.message);
    currentFile = null;
    updateBtn();
    hideProgress();
  }

  updateBtn();
}

// ‚îÄ‚îÄ Text extraction helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function readAsText(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload  = e => res(e.target.result);
    r.onerror = () => rej(new Error('FileReader error'));
    r.readAsText(file);
  });
}

async function extractPDF(file) {
  const buf  = await file.arrayBuffer();
  const pdf  = await pdfjsLib.getDocument({ data: buf }).promise;
  let   text = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    showProgress(10 + Math.round((i / pdf.numPages) * 80));
    const page    = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(s => s.str).join(' ') + '\n\n';
  }
  return text;
}

async function extractDOCX(file) {
  const buf    = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer: buf });
  return result.value;
}

// ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showProgress(pct) {
  progressWrap.classList.add('visible');
  progressBar.style.width = pct + '%';
}
function hideProgress() {
  progressWrap.classList.remove('visible');
  progressBar.style.width = '0%';
}

// ‚îÄ‚îÄ Error helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showExtractError(msg) {
  extractError.textContent = msg;
  extractError.classList.toggle('visible', !!msg);
}

function showAPIError(msg) {
  apiError.textContent = msg;
  apiError.classList.toggle('visible', !!msg);
}

// ‚îÄ‚îÄ Button state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateBtn() {
  const ready = extractedText.trim() && apiKeyInput.value.trim().startsWith('sk-ant');
  summarizeBtn.disabled = !ready;
}
apiKeyInput.addEventListener('input', updateBtn);

// ‚îÄ‚îÄ Build prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPrompt(text, length) {
  const MAX_CHARS = 100000;
  const truncated  = text.length > MAX_CHARS;
  const content    = truncated ? text.slice(0, MAX_CHARS) + '\n\n[Document truncated for length]' : text;

  const instructions = {
    brief:     'Write a brief summary in 2‚Äì3 sentences covering only the core topic and conclusion.',
    standard:  'Write a clear, concise summary in one paragraph (5‚Äì8 sentences) covering the main purpose, key points, and conclusions.',
    detailed:  'Write a detailed summary using bullet points for key sections, findings, arguments, and conclusions. Include any important data, names, or dates.',
    executive: 'Write an executive summary with: (1) a one-sentence overview, (2) key findings/arguments as bullet points, (3) conclusions and recommendations. Use clear headings.',
  };

  return `You are a professional document summarizer. ${instructions[length] || instructions.standard}

Do not add preamble like "This document..." or "Here is a summary...". Start directly with the content.

DOCUMENT:
${content}`;
}

// ‚îÄ‚îÄ Summarize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
summarizeBtn.addEventListener('click', async () => {
  const key    = apiKeyInput.value.trim();
  const model  = modelSelect.value;
  const length = lengthSelect.value;

  if (!key || !extractedText) return;

  outputCard.classList.remove('visible');
  showAPIError('');
  setLoading(true);

  try {
    const prompt = buildPrompt(extractedText, length);

    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type':                          'application/json',
        'x-api-key':                             key,
        'anthropic-version':                     '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model,
        max_tokens: 2048,
        messages: [{ role: 'user', content: prompt }],
      }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({ error: { message: res.statusText } }));
      throw new Error(err?.error?.message || `API error ${res.status}`);
    }

    const data   = await res.json();
    const text   = data.content?.[0]?.text || '';
    const input  = data.usage?.input_tokens  || '‚Äì';
    const output = data.usage?.output_tokens || '‚Äì';

    summaryText.textContent = text;
    tokenInfo.textContent   = `Tokens used: ${Number(input).toLocaleString()} in ¬∑ ${Number(output).toLocaleString()} out`;
    outputCard.classList.add('visible');
    outputCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

  } catch (err) {
    let msg = err.message;
    if (msg.includes('401') || msg.includes('authentication')) msg = '‚ùå Invalid API key. Check your key at console.anthropic.com.';
    else if (msg.includes('429'))  msg = '‚ùå Rate limit reached. Wait a moment and try again.';
    else if (msg.includes('529') || msg.includes('overload')) msg = '‚ùå Anthropic API is overloaded. Please try again shortly.';
    showAPIError(msg);
  } finally {
    setLoading(false);
  }
});

function setLoading(on) {
  summarizeBtn.disabled    = on;
  spinner.style.display    = on ? 'block' : 'none';
  btnLabel.textContent     = on ? 'Summarizing‚Ä¶' : '‚ú¶ Summarize Document';
}

// ‚îÄ‚îÄ Copy to clipboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
copyBtn.addEventListener('click', async () => {
  await navigator.clipboard.writeText(summaryText.textContent);
  copyLabel.textContent = 'Copied!';
  copyBtn.classList.add('copied');
  setTimeout(() => { copyLabel.textContent = 'Copy'; copyBtn.classList.remove('copied'); }, 2000);
});

// ‚îÄ‚îÄ Re-check key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Restore from sessionStorage if present
const savedKey = sessionStorage.getItem('summarizer_key');
if (savedKey) {
  apiKeyInput.value = savedKey;
  updateBtn();
}
apiKeyInput.addEventListener('change', () => {
  if (apiKeyInput.value.startsWith('sk-ant')) {
    sessionStorage.setItem('summarizer_key', apiKeyInput.value);
  }
});
</script>
</body>
</html>
